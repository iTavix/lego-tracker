<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iTavix LEGO Manager v10.3</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .blur-content { filter: blur(5px); pointer-events: none; user-select: none; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .set-thumb { transition: transform 0.2s ease-in-out; cursor: pointer; background: white; }
        .set-thumb:hover { transform: scale(3.5); z-index: 50; position: relative; border-radius: 4px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); border: 2px solid white; }
        .transition-colors { transition-duration: 200ms; }
        header { flex-shrink: 0; }
        .lego-bg { background-image: url('https://images.unsplash.com/photo-1587654780291-39c9404d746b?auto=format&fit=crop&q=80'); background-size: cover; background-position: center; }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        .delay-100 { animation-delay: 0.1s; } .delay-200 { animation-delay: 0.2s; } .delay-300 { animation-delay: 0.3s; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden flex flex-col bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors">

    <div id="welcomeOverlay" class="fixed inset-0 z-[200] lego-bg flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-gray-900/90 backdrop-blur-sm"></div>
        <div class="relative z-10 w-full max-w-4xl p-6 h-full overflow-y-auto flex flex-col justify-center text-center">
            <h1 class="text-4xl font-black text-white mb-4">iTavix Manager 10.3</h1>
            <p class="text-gray-300 mb-8">Gestione Collezioni, Prezzi e Esclusive</p>
            <button onclick="closeWelcome()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-full shadow-xl">Inizia</button>
        </div>
    </div>

    <div id="loginOverlay" class="fixed inset-0 z-[100] lego-bg flex items-center justify-center transition-opacity duration-500">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="bg-white/95 backdrop-blur p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 text-center relative z-10 border border-white/20">
            <img src="logo.png" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/2/24/LEGO_logo.svg'" class="w-20 h-20 object-contain mx-auto mb-4">
            <h2 class="text-3xl font-bold text-gray-800">Login</h2>
            <div class="space-y-4 text-left mt-6">
                <div><label class="block text-xs font-bold text-gray-500 uppercase ml-1">Email</label><input type="text" id="email" class="w-full px-4 py-3 border rounded-xl outline-none text-gray-800"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase ml-1">Password</label><input type="password" id="password" class="w-full px-4 py-3 border rounded-xl outline-none text-gray-800"></div>
                <div id="authMessage" class="hidden p-3 rounded-lg text-sm text-center font-medium"></div>
                <div class="flex gap-3 pt-2">
                    <button id="btnLogin" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700">Accedi</button>
                    <button id="btnSignup" class="flex-1 bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200">Registrati</button>
                </div>
            </div>
        </div>
    </div>

    <div id="priceModal" class="fixed inset-0 z-[60] bg-black/50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold mb-4 dark:text-white" id="modalTitle">Aggiorna Dati</h3>
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-500">Set: <span id="modalSetCode" class="font-mono font-bold"></span></p>
                <a id="bricksetLink" href="#" target="_blank" class="text-xs text-blue-500 hover:underline flex items-center gap-1">Check Brickset <i data-lucide="external-link" class="w-3 h-3"></i></a>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between bg-purple-50 dark:bg-purple-900/30 p-3 rounded-lg border border-purple-100 dark:border-purple-800">
                    <div class="flex flex-col"><label for="editIsExclusive" class="text-sm font-bold text-purple-700 dark:text-purple-300 flex items-center gap-2"><i data-lucide="gem" class="w-4 h-4"></i> Esclusiva</label></div>
                    <input type="checkbox" id="editIsExclusive" class="w-5 h-5 accent-purple-600 rounded">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Listino (€)</label><input type="number" step="0.01" id="suggestPrice" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Mercato (€)</label><input type="number" step="0.01" id="suggestMarketPrice" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Fonte</label><input type="text" id="suggestSource" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closePriceModal()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg">Annulla</button>
                <button onclick="submitSuggestion()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Salva</button>
            </div>
        </div>
    </div>

    <div id="addSetModal" class="fixed inset-0 z-[65] bg-black/50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-2"><i data-lucide="package-plus" class="text-blue-500"></i> Nuovo Set</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-1"><label class="text-xs font-bold text-gray-500 uppercase">Codice *</label><input type="number" id="newSetCod" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-gray-500 uppercase">Tema</label><select id="newSetTheme" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"><option value="">Seleziona...</option></select></div>
                <div class="col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Nome *</label><input type="text" id="newSetName" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-gray-500 uppercase">Pezzi</label><input type="number" id="newSetPieces" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-gray-500 uppercase">Listino (€)</label><input type="number" step="0.01" id="newSetPrice" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
                <div class="col-span-2 flex items-center gap-2 mt-2 bg-purple-50 dark:bg-purple-900/20 p-2 rounded"><input type="checkbox" id="newSetExclusive" class="w-4 h-4 accent-purple-600"><label for="newSetExclusive" class="text-sm font-medium text-purple-700 dark:text-purple-300">Set Esclusivo (D2C)</label></div>
                <div class="col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Data Ritiro</label><input type="date" id="newSetDate" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white outline-none"></div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="document.getElementById('addSetModal').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg">Annulla</button>
                <button onclick="addNewSet()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Aggiungi</button>
            </div>
        </div>
    </div>

    <div id="adminModal" class="fixed inset-0 z-[70] bg-black/50 hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-4 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold dark:text-white">Moderazione</h3><button onclick="document.getElementById('adminModal').classList.add('hidden')" class="text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button></div>
            <div class="flex-1 overflow-y-auto custom-scroll"><table class="w-full text-left text-sm"><thead class="bg-gray-100 dark:bg-gray-700 sticky top-0"><tr><th class="p-2">Set</th><th class="p-2">Utente</th><th class="p-2">Prezzo</th><th class="p-2">Fonte</th><th class="p-2 text-right">Azioni</th></tr></thead><tbody id="adminTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody></table><p id="noSuggestions" class="text-center text-gray-500 mt-10 hidden">Nessun dato.</p></div>
        </div>
    </div>

    <div id="appContent" class="flex flex-col h-full blur-content transition-all duration-500 opacity-50">
        <header class="flex-none bg-white dark:bg-gray-800 shadow-sm z-30 relative px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center gap-3 w-full md:w-auto"><img src="logo.png" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/2/24/LEGO_logo.svg'" class="w-10 h-10 object-contain"><div><h1 class="text-lg md:text-xl font-bold leading-tight">iTavix Manager</h1><p class="text-[10px] text-gray-500 dark:text-gray-400" id="userEmailDisplay">...</p></div></div>
            <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto no-scrollbar">
                <button id="btnAddSet" onclick="openAddSetModal()" class="hidden p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Nuovo Set"><i data-lucide="plus" class="w-4 h-4"></i></button>
                <button id="btnAdmin" onclick="openAdminPanel()" class="hidden p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Moderazione"><img src="logo.png" class="w-4 h-4 object-contain"></button>
                <button onclick="toggleDarkMode()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 transition"><i data-lucide="moon" class="w-4 h-4 dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block text-yellow-400"></i></button>
                <button onclick="toggleDashboard()" class="flex items-center px-3 py-2 bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-200 rounded-lg hover:bg-purple-200 transition gap-2 text-xs md:text-sm font-bold"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> <span class="hidden sm:inline">Dash</span></button>
                <button id="btnToggleExcl" onclick="toggleExclusives()" class="flex items-center px-3 py-2 bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 rounded-lg hover:bg-indigo-200 transition gap-2 text-xs md:text-sm font-bold"><i data-lucide="gem" class="w-4 h-4"></i> <span id="exclBtnText">Esclusive</span></button>
                <button id="btnToggleFavs" onclick="toggleViewFavorites()" class="flex items-center px-3 py-2 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded-lg hover:bg-yellow-200 transition gap-2 text-xs md:text-sm font-bold"><i data-lucide="box" class="w-4 h-4"></i> <span id="favBtnText">Collezione</span></button>
                <label class="p-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition"><i data-lucide="upload-cloud" class="w-4 h-4"></i><input type="file" id="csvInput" accept=".csv" class="hidden"></label>
                <button onclick="exportToCSV()" class="p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"><i data-lucide="download" class="w-4 h-4"></i></button>
                <button onclick="logout()" class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </header>

        <div id="dashboardPanel" class="hidden flex-none bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-4 transition-all overflow-y-auto max-h-[40vh]">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-w-7xl mx-auto">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm"><h3 class="text-xs font-bold uppercase text-gray-500 mb-2">Temi</h3><div class="h-32"><canvas id="chartThemes"></canvas></div></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm"><h3 class="text-xs font-bold uppercase text-gray-500 mb-2">Ritiro</h3><div class="h-32"><canvas id="chartRetirement"></canvas></div></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm text-center"><p class="text-sm text-gray-500">Valore Intero DB</p><p class="text-3xl font-bold text-gray-800 dark:text-white mt-1" id="dashDBValue">€ 0</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm text-center"><p class="text-sm text-gray-500">Valore Mia Collezione</p><p class="text-3xl font-bold text-green-600 dark:text-green-400 mt-1" id="dashCollectionValue">€ 0</p></div>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto custom-scroll relative bg-gray-50 dark:bg-gray-900">
            <div id="tableLoader" class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 z-20 flex flex-col items-center justify-center hidden"><div class="loader mb-2"></div><p class="text-gray-500 text-xs animate-pulse">Sync...</p></div>
            <div class="p-2 md:p-4 space-y-3 pb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-xs md:text-sm bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="border-r border-gray-100 dark:border-gray-700"><span class="text-gray-400 block text-[10px] uppercase">DB Totale</span> <b class="text-gray-800 dark:text-gray-200" id="statDBCount">-</b> / <b class="text-blue-600" id="statDBValue">-</b></div>
                    <div class="border-r border-gray-100 dark:border-gray-700"><span class="text-gray-400 block text-[10px] uppercase">Collezione</span> <b class="text-gray-800 dark:text-gray-200" id="statCollCount">-</b> / <b class="text-green-600 font-bold" id="statCollValue">-</b></div>
                    <div class="border-r border-gray-100 dark:border-gray-700"><span class="text-gray-400 block text-[10px] uppercase">Ritiro 2025</span> <b class="text-orange-500" id="statRetiring">-</b></div>
                    <div><span class="text-gray-400 block text-[10px] uppercase">Pezzi Totali</span> <b class="text-blue-500" id="statPieces">-</b></div>
                </div>
                <div class="flex flex-col md:flex-row gap-2">
                    <div class="relative flex-1"><i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i><input type="text" id="searchInput" placeholder="Cerca..." class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 dark:border-gray-700 rounded-md focus:ring-1 focus:ring-purple-500 outline-none bg-white dark:bg-gray-800 dark:text-white"></div>
                    <select id="themeFilter" class="p-2 text-sm border border-gray-200 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 dark:text-white outline-none w-full md:w-auto"><option value="all">Tutti i Temi</option></select>
                    <select id="yearFilter" class="p-2 text-sm border border-gray-200 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 dark:text-white outline-none w-full md:w-auto"><option value="all">Tutti gli Anni</option></select>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-x-auto min-h-[400px]">
                    <table class="w-full text-left border-collapse min-w-[900px]">
                        <thead class="bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 sticky top-0 z-10 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            <tr>
                                <th class="p-3 text-center w-28">Stato</th><th class="p-3 text-center w-14">Img</th>
                                <th class="p-3 cursor-pointer hover:text-blue-500" onclick="sortTable('cod')">Cod</th>
                                <th class="p-3 cursor-pointer hover:text-blue-500" onclick="sortTable('theme')">Tema</th>
                                <th class="p-3 cursor-pointer hover:text-blue-500" onclick="sortTable('set_name')">Nome</th>
                                <th class="p-3 text-right cursor-pointer hover:text-blue-500" onclick="sortTable('pieces')">Pezzi</th>
                                <th class="p-3 text-right cursor-pointer hover:text-blue-500" onclick="sortTable('price')">Listino</th>
                                <th class="p-3 text-right cursor-pointer hover:text-blue-500" onclick="sortTable('market_price')">Mercato</th>
                                <th class="p-3 text-right cursor-pointer hover:text-blue-500" onclick="sortTable('retirement_date')">Ritiro</th>
                                <th class="p-3 text-center w-24">Link</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100 dark:divide-gray-700 text-sm text-gray-700 dark:text-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="flex-none bg-white dark:bg-gray-800 p-2 border-t border-gray-200 dark:border-gray-700 text-center z-30">
            <p class="text-[10px] md:text-xs text-gray-400 dark:text-gray-500"><span class="font-bold text-gray-600 dark:text-gray-300">iTavix v10.3</span> • Aggiornato: <span id="lastUpdateDate">-</span></p>
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://vdihgygqxjuhnppwktlq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkaWhneWdxeGp1aG5wcHdrdGxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDYyNzYsImV4cCI6MjA4MDYyMjI3Nn0.A-emTugF0lfrfHlIm7M6HXUFNwaDs_TRPE3NvLqJo2o';
        const ADMIN_EMAIL = 'clauditavi@gmail.com'; 

        let supabase;
        let allData = [];
        let filteredData = [];
        let userLibrary = new Map();
        let currentSort = { key: 'retirement_date', direction: 'asc' };
        let showOnlyCollection = false;
        let showOnlyExclusives = false;
        let currentUserEmail = "";
        let charts = {};
        let currentEditingCod = null;

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initDarkMode();
            if(!localStorage.getItem('itavix_welcome_seen')) document.getElementById('welcomeOverlay').classList.remove('hidden');
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                checkSession();
            } catch (e) { alert("Config Error"); }
        });

        function closeWelcome() { document.getElementById('welcomeOverlay').classList.add('hidden'); localStorage.setItem('itavix_welcome_seen', 'true'); }
        function safeUpdate(id, val) { const el = document.getElementById(id); if (el) el.innerText = val; }
        function formatDateItalian(dateString) { if (!dateString) return "-"; const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; return date.toLocaleDateString('it-IT'); }
        function initDarkMode() { if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); updateCharts(); }

        // AUTH
        async function checkSession() { try { const { data } = await supabase.auth.getSession(); if (data.session) unlockApp(data.session.user.email); } catch (e) {} }
        document.getElementById('password').addEventListener('keypress', (e) => { if (e.key==='Enter') handleAuth('login'); });
        document.getElementById('btnLogin').addEventListener('click', () => handleAuth('login'));
        document.getElementById('btnSignup').addEventListener('click', () => handleAuth('signup'));

        async function handleAuth(type) {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const msgBox = document.getElementById('authMessage'); msgBox.classList.add('hidden');
            if(!email || !password) return showAuthMsg("Inserisci dati", true);
            try {
                const { data, error } = type === 'login' ? await supabase.auth.signInWithPassword({ email, password }) : await supabase.auth.signUp({ email, password });
                if (error) throw error;
                if (type === 'signup' && !data.session) showAuthMsg("Registrazione OK! Controlla email", false);
                else unlockApp(data.user.email);
            } catch (err) { showAuthMsg(err.message, true); }
        }
        function showAuthMsg(txt, isErr) { const m = document.getElementById('authMessage'); m.innerText = txt; m.className = `p-3 rounded-lg text-sm text-center font-medium block ${isErr ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`; m.classList.remove('hidden'); }

        function unlockApp(email) {
            currentUserEmail = email;
            if (email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('btnAdmin').classList.remove('hidden');
                document.getElementById('btnAddSet').classList.remove('hidden');
            }
            document.getElementById('loginOverlay').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => document.getElementById('loginOverlay').style.display = 'none', 500);
            document.getElementById('appContent').classList.remove('blur-content', 'opacity-50');
            document.getElementById('appContent').classList.add('opacity-100');
            document.getElementById('userEmailDisplay').innerHTML = `Utente: <b>${email}</b>`;
            
            // SEPARATE LOADS
            loadLastUpdateDate();
            loadLibrary().then(() => fetchAllData());
        }
        async function logout() { await supabase.auth.signOut(); location.reload(); }

        // LOGIC
        async function loadLibrary() { try { const { data } = await supabase.from('user_favorites').select('set_cod, status, quantity').eq('user_email', currentUserEmail); if (data) { userLibrary = new Map(); data.forEach(row => userLibrary.set(row.set_cod, { status: row.status || 'wanted', qty: row.quantity || 1 })); } } catch(e) { console.error("Lib Load", e); } }
        async function updateSetStatus(cod, status) {
            const current = userLibrary.get(cod);
            if (current && current.status === status) { userLibrary.delete(cod); await supabase.from('user_favorites').delete().match({ user_email: currentUserEmail, set_cod: cod }); }
            else { const newData = { status: status, qty: current ? current.qty : 1 }; userLibrary.set(cod, newData); await supabase.from('user_favorites').upsert({ user_email: currentUserEmail, set_cod: cod, status: status, quantity: newData.qty }, { onConflict: 'user_email, set_cod' }); }
            refreshView();
        }
        async function updateQty(cod, delta) {
            const current = userLibrary.get(cod); if (!current) return;
            let newQty = Math.max(1, current.qty + delta); current.qty = newQty; userLibrary.set(cod, current);
            await supabase.from('user_favorites').update({ quantity: newQty }).match({ user_email: currentUserEmail, set_cod: cod });
            render(); updateDashboardStats();
        }

        function openAddSetModal() { document.getElementById('addSetModal').classList.remove('hidden'); }
        async function addNewSet() {
            const cod = parseInt(document.getElementById('newSetCod').value);
            const theme = document.getElementById('newSetTheme').value;
            const name = document.getElementById('newSetName').value;
            const pieces = parseInt(document.getElementById('newSetPieces').value || 0);
            const price = parseFloat(document.getElementById('newSetPrice').value || 0);
            const isExclusive = document.getElementById('newSetExclusive').checked;
            const date = document.getElementById('newSetDate').value;
            if(!cod || !name) { alert("Codice e Nome sono obbligatori!"); return; }
            let formattedDate = date ? new Date(date).toISOString().split('T')[0] : "";
            const { error } = await supabase.from('lego_sets').insert({ cod: cod, theme: theme, set_name: name, pieces: pieces, price: price, market_price: price, is_exclusive: isExclusive, retirement_date: formattedDate });
            if(error) alert("Errore inserimento: " + error.message);
            else { alert("Set aggiunto!"); document.getElementById('addSetModal').classList.add('hidden'); fetchAllData(); }
        }

        function openPriceModal(cod) { 
            currentEditingCod = cod; document.getElementById('modalSetCode').innerText = cod; 
            document.getElementById('bricksetLink').href = `https://brickset.com/sets/${cod}-1`;
            const set = allData.find(d => d.cod === cod);
            if(set) {
                document.getElementById('suggestPrice').value = set._price; 
                document.getElementById('suggestMarketPrice').value = set._market;
                document.getElementById('editIsExclusive').checked = set.is_exclusive === true;
            }
            document.getElementById('suggestSource').value = ''; 
            const title = document.getElementById('modalTitle');
            if(currentUserEmail.toLowerCase() === ADMIN_EMAIL.toLowerCase()) title.innerText = "Aggiorna Dati (Admin)";
            else title.innerText = "Suggerisci Dati";
            document.getElementById('priceModal').classList.remove('hidden'); 
        }
        function closePriceModal() { document.getElementById('priceModal').classList.add('hidden'); currentEditingCod = null; }
        
        async function submitSuggestion() {
            const price = parseFloat(document.getElementById('suggestPrice').value); 
            const market = parseFloat(document.getElementById('suggestMarketPrice').value);
            const isExcl = document.getElementById('editIsExclusive').checked;
            const source = document.getElementById('suggestSource').value;
            
            if (currentUserEmail.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                const updateData = { is_exclusive: isExcl };
                if(!isNaN(price)) updateData.price = price;
                if(!isNaN(market)) updateData.market_price = market;
                
                const { error } = await supabase.from('lego_sets').update(updateData).eq('cod', currentEditingCod);
                if(error) alert("Errore: " + error.message); else { alert("Aggiornato!"); closePriceModal(); fetchAllData(); }
            } else {
                if(!price || !source) { alert("Prezzo e Fonte obbligatori"); return; }
                const { error } = await supabase.from('price_suggestions').insert({ set_cod: currentEditingCod, user_email: currentUserEmail, new_price: price, source: source });
                if(error) alert("Errore: " + error.message); else { alert("Inviato!"); closePriceModal(); }
            }
        }

        async function openAdminPanel() { document.getElementById('adminModal').classList.remove('hidden'); loadSuggestions(); }
        async function loadSuggestions() {
            const tbody = document.getElementById('adminTableBody'); tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
            const { data } = await supabase.from('price_suggestions').select('*').eq('status', 'pending').order('created_at');
            tbody.innerHTML = '';
            if(!data || data.length === 0) { document.getElementById('noSuggestions').classList.remove('hidden'); return; }
            document.getElementById('noSuggestions').classList.add('hidden');
            data.forEach(s => {
                const tr = document.createElement('tr'); tr.className = "border-b border-gray-100 dark:border-gray-700";
                tr.innerHTML = `<td class="p-2 font-mono">${s.set_cod}</td><td class="p-2 text-xs truncate max-w-[100px]">${s.user_email}</td><td class="p-2 font-bold text-green-600">€ ${s.new_price}</td><td class="p-2 text-xs italic">${s.source}</td><td class="p-2 text-right"><button onclick="approveSuggestion(${s.id}, ${s.set_cod}, ${s.new_price})" class="bg-green-100 text-green-700 p-1 rounded mr-1"><i data-lucide="check" class="w-4 h-4"></i></button><button onclick="rejectSuggestion(${s.id})" class="bg-red-100 text-red-700 p-1 rounded"><i data-lucide="x" class="w-4 h-4"></i></button></td>`;
                tbody.appendChild(tr);
            }); lucide.createIcons();
        }
        async function approveSuggestion(id, cod, price) {
            await supabase.from('lego_sets').update({ price: price }).eq('cod', cod);
            await supabase.from('price_suggestions').update({ status: 'approved' }).eq('id', id);
            await loadSuggestions(); await fetchAllData();
        }
        async function rejectSuggestion(id) { await supabase.from('price_suggestions').update({ status: 'rejected' }).eq('id', id); loadSuggestions(); }

        function refreshView() {
            if (showOnlyExclusives) {
                filteredData = allData.filter(d => d.is_exclusive === true); 
                document.getElementById('exclBtnText').innerText = "Mostra Tutti";
            } else if (showOnlyCollection) {
                filteredData = allData.filter(d => userLibrary.has(d.cod));
            } else {
                applyFilters(); return;
            }
            render(); updateDashboardStats(); updateCharts();
        }
        
        function toggleExclusives() {
            showOnlyExclusives = !showOnlyExclusives;
            showOnlyCollection = false; 
            document.getElementById('favBtnText').innerText = "Collezione";
            document.getElementById('btnToggleFavs').className = "flex items-center px-3 py-2 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded-lg hover:bg-yellow-200 transition gap-2 text-xs md:text-sm font-bold";

            const btn = document.getElementById('btnToggleExcl');
            if(showOnlyExclusives) {
                btn.className = "flex items-center px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition gap-2 text-xs md:text-sm font-bold";
                document.getElementById('exclBtnText').innerText = "Mostra Tutti";
            } else {
                btn.className = "flex items-center px-3 py-2 bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 rounded-lg hover:bg-indigo-200 transition gap-2 text-xs md:text-sm font-bold";
                document.getElementById('exclBtnText').innerText = "Esclusive";
            }
            refreshView();
        }

        async function fetchAllData() {
            const loader = document.getElementById('tableLoader'); loader.classList.remove('hidden');
            let allRows = []; let from = 0; const step = 1000; let keep = true;
            try { 
                while(keep) { 
                    // FETCH COMPLETA
                    const { data, error } = await supabase.from('lego_sets').select('*').range(from, from + step - 1); 
                    if (error) { console.error(error); throw new Error(error.message); }
                    if (data && data.length > 0) { allRows = allRows.concat(data); from += step; if (data.length < step) keep = false; } else keep = false; 
                } 
                processData(allRows); 
            } catch (e) { 
                alert("ERRORE CARICAMENTO DATI:\n" + e.message + "\n\nAssicurati di aver eseguito lo script SQL!"); 
            } finally { loader.classList.add('hidden'); }
        }
        
        async function loadLastUpdateDate() { try { const { data } = await supabase.from('app_settings').select('value').eq('key', 'last_data_update').single(); if (data) safeUpdate('lastUpdateDate', new Date(data.value).toLocaleDateString('it-IT')); } catch(e) {} }

        // CSV
        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            Papa.parse(file, { header: true, skipEmptyLines: true, delimiter: "", complete: async function(results) {
                try {
                    const rows = results.data.map(row => {
                        const keys = Object.keys(row); const getK = (n) => keys.find(k => k.toLowerCase().includes(n));
                        let price = row[getK('price')] || row[getK('costo')] || '0'; if(typeof price === 'string') price = price.replace('€','').replace(',','.').trim();
                        return { cod: parseInt(row[getK('cod')]), theme: row[getK('theme')], sub_theme: row[getK('sub')] || "", set_name: row[getK('name')], pieces: parseInt(row[getK('pieces')] || 0), price: parseFloat(price || 0), retirement_date: row[getK('date')] || row[getK('ritiro')] };
                    }).filter(r => r.cod);
                    const BATCH = 50; for(let i=0; i<rows.length; i+=BATCH) { await supabase.from('lego_sets').upsert(rows.slice(i, i+BATCH), { onConflict: 'cod' }); }
                    const now = new Date().toISOString(); await supabase.from('app_settings').upsert({ key: 'last_data_update', value: now });
                    safeUpdate('lastUpdateDate', new Date().toLocaleDateString('it-IT')); alert(`Completato!`); fetchAllData();
                } catch (err) {} e.target.value = '';
            }});
        });

        function exportToCSV() {
            if (filteredData.length === 0) { alert("Nessun dato!"); return; }
            const dataToExport = filteredData.map(row => { const lib = userLibrary.get(row.cod); return { Codice: row.cod, Tema: row.theme, Nome: row.set_name, Pezzi: row.pieces, Prezzo: row._price, Ritiro: row.retirement_date, Posseduto: lib && lib.status === 'owned' ? 'SI' : 'NO', Desiderato: lib && lib.status === 'wanted' ? 'SI' : 'NO', Quantità: lib ? lib.qty : 0, Link: `https://www.lego.com/it-it/product/${row.cod}` }; });
            const csv = Papa.unparse(dataToExport); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `itavix_export.csv`; link.click();
        }

        function processData(data) {
            allData = data.map(item => ({ 
                ...item, 
                _date: new Date(item.retirement_date || '2099-12-31'), 
                _search: ((item.set_name||'') + ' ' + item.cod).toLowerCase(), 
                _price: parseFloat(item.price || 0), 
                _market: parseFloat(item.market_price || item.price || 0), 
                _img: `https://images.brickset.com/sets/images/${item.cod}-1.jpg` 
            }));
            
            const themes = [...new Set(allData.map(d => d.theme).filter(Boolean))].sort(); 
            const years = [...new Set(allData.map(d => d._date.getFullYear()))].sort().filter(y => !isNaN(y) && y < 2099);
            
            const themeOptions = '<option value="">Seleziona...</option>' + themes.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('themeFilter').innerHTML = '<option value="all">Tutti i Temi</option>' + themes.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('yearFilter').innerHTML = '<option value="all">Tutti gli Anni</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('newSetTheme').innerHTML = themeOptions;

            applyFilters();
        }

        function applyFilters() {
            const s = document.getElementById('searchInput').value.toLowerCase(); const t = document.getElementById('themeFilter').value; const y = document.getElementById('yearFilter').value;
            filteredData = allData.filter(d => { const baseMatch = (d._search.includes(s)) && (t === 'all' || d.theme === t) && (y === 'all' || d._date.getFullYear().toString() === y); if (showOnlyCollection) return baseMatch && userLibrary.has(d.cod); return baseMatch; });
            render(); updateDashboardStats(); updateCharts();
        }

        function toggleDashboard() { document.getElementById('dashboardPanel').classList.toggle('hidden'); updateCharts(); }
        function toggleViewFavorites() { 
            showOnlyCollection = !showOnlyCollection; 
            showOnlyExclusives = false;
            document.getElementById('exclBtnText').innerText = "Esclusive";
            document.getElementById('btnToggleExcl').className = "flex items-center px-3 py-2 bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 rounded-lg hover:bg-indigo-200 transition gap-2 text-xs md:text-sm font-bold";

            const btn = document.getElementById('btnToggleFavs'); 
            if (showOnlyCollection) { 
                btn.className = "flex items-center px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition gap-2 text-xs md:text-sm font-bold"; 
                document.getElementById('favBtnText').innerText = "Mostra Tutti"; 
            } else { 
                btn.className = "flex items-center px-3 py-2 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded-lg hover:bg-yellow-200 transition gap-2 text-xs md:text-sm font-bold"; 
                document.getElementById('favBtnText').innerText = "La Mia Collezione"; 
            } 
            refreshView(); 
        }

        function updateDashboardStats() {
            let dbValue = 0; let collectionValue = 0; let collectionCount = 0;
            allData.forEach(d => dbValue += d._market);
            allData.forEach(d => { const lib = userLibrary.get(d.cod); if (lib && lib.status === 'owned') { collectionValue += d._market * lib.qty; collectionCount++; } });

            safeUpdate('statDBCount', allData.length.toLocaleString());
            safeUpdate('statDBValue', `€ ${dbValue.toLocaleString('it-IT', {minimumFractionDigits:0})}`);
            safeUpdate('statCollCount', collectionCount.toLocaleString());
            safeUpdate('statCollValue', `€ ${collectionValue.toLocaleString('it-IT', {minimumFractionDigits:0})}`);
            safeUpdate('statRetiring', filteredData.filter(d => d._date.getFullYear() === 2025).length);
            safeUpdate('statPieces', filteredData.reduce((a,b) => a+(b.pieces||0), 0).toLocaleString());
            safeUpdate('dashDBValue', `€ ${dbValue.toLocaleString('it-IT', {minimumFractionDigits:0})}`);
            safeUpdate('dashCollectionValue', `€ ${collectionValue.toLocaleString('it-IT', {minimumFractionDigits:0})}`);
        }

        function updateCharts() {
            if (document.getElementById('dashboardPanel').classList.contains('hidden')) return;
            if (typeof Chart === 'undefined') return;

            const ownedSets = allData.filter(d => { const lib = userLibrary.get(d.cod); return lib && lib.status === 'owned'; });
            if (ownedSets.length === 0) return;
            const themes = {}; ownedSets.forEach(d => themes[d.theme] = (themes[d.theme]||0) + (userLibrary.get(d.cod).qty));
            if (charts.theme) charts.theme.destroy(); charts.theme = new Chart(document.getElementById('chartThemes'), { type: 'doughnut', data: { labels: Object.keys(themes), datasets: [{ data: Object.values(themes), backgroundColor: ['#ef4444', '#3b82f6', '#eab308', '#22c55e', '#a855f7', '#64748b'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            const years = {}; ownedSets.forEach(d => { const y = d._date.getFullYear(); if(y < 2099) years[y] = (years[y]||0) + 1; });
            if (charts.retire) charts.retire.destroy(); charts.retire = new Chart(document.getElementById('chartRetirement'), { type: 'bar', data: { labels: Object.keys(years).sort(), datasets: [{ label: 'Set in Ritiro', data: Object.keys(years).sort().map(k => years[k]), backgroundColor: '#f97316' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        function render() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            filteredData.sort((a,b) => { let vA = a[currentSort.key], vB = b[currentSort.key]; if(currentSort.key === 'retirement_date') { vA=a._date; vB=b._date; } if(currentSort.key === 'price') { vA=a._price; vB=b._price; } return (vA < vB ? -1 : 1) * (currentSort.direction === 'asc' ? 1 : -1); });
            const frag = document.createDocumentFragment();
            filteredData.forEach(row => {
                const tr = document.createElement('tr'); tr.className = "hover:bg-purple-50 dark:hover:bg-gray-700 transition border-b border-gray-100 dark:border-gray-700";
                const now = new Date(); const diffDays = Math.ceil((row._date - now) / (1000 * 60 * 60 * 24)); 
                let retireClass = "text-gray-600 dark:text-gray-400"; if (row._date.getFullYear() === 2025) retireClass = diffDays < 180 ? "text-red-600 font-bold bg-red-100 dark:bg-red-900/30 px-2 py-0.5 rounded" : "text-orange-600 font-bold";
                const lib = userLibrary.get(row.cod); const isOwned = lib && lib.status === 'owned'; const isWanted = lib && lib.status === 'wanted';
                const btnOwned = `<button onclick="updateSetStatus(${row.cod}, 'owned')" class="p-1.5 rounded-md transition ${isOwned ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'text-gray-300 hover:text-green-500'}"><i data-lucide="package" class="w-4 h-4"></i></button>`;
                const btnWanted = `<button onclick="updateSetStatus(${row.cod}, 'wanted')" class="p-1.5 rounded-md transition ${isWanted ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'text-gray-300 hover:text-red-500'}"><i data-lucide="heart" class="w-4 h-4"></i></button>`;
                let qtyControls = isOwned ? `<div class="flex items-center gap-1 text-xs font-mono mt-1 justify-center"><button onclick="updateQty(${row.cod}, -1)" class="hover:bg-gray-200 px-1 rounded">-</button><span class="font-bold text-gray-800 dark:text-white">${lib.qty}</span><button onclick="updateQty(${row.cod}, 1)" class="hover:bg-gray-200 px-1 rounded">+</button></div>` : '';
                
                let marketClass = "text-gray-500";
                if(row._market) {
                    if(row._market > row._price) marketClass = "text-red-500 font-bold";
                    else if(row._market < row._price) marketClass = "text-green-600 font-bold";
                }

                const dateDisplay = formatDateItalian(row.retirement_date);

                const exclIcon = row.is_exclusive ? '<i data-lucide="gem" class="w-3.5 h-3.5 text-purple-500 inline ml-1" title="Esclusiva"></i>' : '';

                tr.innerHTML = `
                    <td class="p-3 text-center align-top"><div class="flex justify-center gap-1">${btnOwned}${btnWanted}</div>${qtyControls}</td>
                    <td class="p-3 text-center align-top"><div class="relative group w-12 h-12 mx-auto"><img src="${row._img}" loading="lazy" class="w-full h-full object-contain set-thumb bg-white rounded p-0.5 border border-gray-200" onerror="this.style.display='none'"></div></td>
                    <td class="p-3 text-sm font-mono text-blue-600 dark:text-blue-400 align-middle"><a href="https://www.lego.com/it-it/product/${row.cod}" target="_blank">${row.cod}</a></td>
                    <td class="p-3 text-sm align-middle"><span class="bg-gray-100 dark:bg-gray-700 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">${row.theme}</span></td>
                    <td class="p-3 text-sm font-medium dark:text-white align-middle">${row.set_name} ${exclIcon}</td>
                    <td class="p-3 text-sm text-right text-gray-500 dark:text-gray-400 align-middle">${row.pieces||0}</td>
                    <td class="p-3 text-sm text-right font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap align-middle">
                        ${row._price > 0 ? '€ '+row._price.toFixed(2) : '-'}
                        <button onclick="openPriceModal(${row.cod})" class="ml-1 text-gray-400 hover:text-blue-500 text-xs"><i data-lucide="edit-2" class="w-3 h-3 inline"></i></button>
                    </td>
                    <td class="p-3 text-sm text-right font-medium whitespace-nowrap align-middle ${marketClass}">
                        ${row._market > 0 ? '€ '+row._market.toFixed(2) : '-'}
                    </td>
                    <td class="p-3 text-sm text-right font-medium whitespace-nowrap align-middle"><span class="${retireClass}">${dateDisplay}</span></td>
                    <td class="p-3 text-center align-middle"><div class="flex justify-center gap-2"><a href="https://www.bricklink.com/v2/catalog/catalogitem.page?S=${row.cod}-1" target="_blank" title="BrickLink" class="text-gray-400 hover:text-blue-500"><i data-lucide="external-link" class="w-4 h-4"></i></a><a href="https://www.amazon.it/s?k=lego+${row.cod}" target="_blank" title="Amazon" class="text-gray-400 hover:text-orange-500"><i data-lucide="shopping-cart" class="w-4 h-4"></i></a></div></td>
                `;
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
            lucide.createIcons();
        }
        function sortTable(k) { if(currentSort.key === k) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; else { currentSort.key = k; currentSort.direction = 'asc'; } render(); }
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('themeFilter').addEventListener('change', applyFilters);
        document.getElementById('yearFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>